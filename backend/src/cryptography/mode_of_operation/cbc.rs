use crate::cryptography::aes::{aes_decrypt, aes_encrypt, AESKey};
use crate::cryptography::mode_of_operation::{BasicModeOfOperation, ModeOfOperation};

#[derive(Debug)]
/// The `Cipher Block Chaining` mode encodes each block and XORed the result with the next
/// message in order. The resulting cipher of that is then again XORed with the next block.
/// https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Cipher_block_chaining_(CBC)
pub struct CBC {
    pub iv: u128,
}

impl ModeOfOperation for CBC {}

impl BasicModeOfOperation for CBC {
    fn encrypt<K: AESKey>(&self, key: &K, plaintext: &[u128]) -> Vec<u128> {
        let mut c_last = self.iv;
        let mut res = Vec::with_capacity(plaintext.len());

        for plain_block in plaintext {
            c_last = aes_encrypt(*plain_block ^ c_last, key);
            res.push(c_last);
        }

        res
    }

    fn decrypt<K: AESKey>(&self, key: &K, ciphertext: &[u128]) -> Vec<u128> {
        let mut c_last = self.iv;
        let mut res = Vec::with_capacity(ciphertext.len());

        for cipher_block in ciphertext {
            let plain_block = c_last ^ aes_decrypt(*cipher_block, key);
            res.push(plain_block);
            c_last = *cipher_block;
        }

        res
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::cryptography::aes::{AESKey128, AESKey192, AESKey256};
    use crate::cryptography::mode_of_operation::tests::{test_decrypt, test_encrypt};

    #[test]
    fn cbc_encrypt_128() {
        test_encrypt::<AESKey128, CBC>(
            "0949b2c324f5765eabb2ca1874997f9b",
            "04836e935f9fdaf28ce2c1f36f642d0ed91bd11f6027182983d57e20c56398fa8145932e60100c940f2ff10fd62a4b46e313859f1afcdbd095a7eea6ad0f18d89f75c9a5e6b9545487aab3702a20d914c7510ce097445eba2fac9a12f8fe8da91d4c7ee6c7baf45cb76f0a79f76a9ac6155b20a516dfaabb2792ce4e1bb0896c",
            "f6eccd7a040b22c9a98cdd6c43d7a200717a9f18ad5de226da187200f76432d9511afb667ed398cc407c1472eebd5ab6da19eca61fdc892a2f85cb687caada90f6dc95b18f97fded254e74356fc3379958df16789ebf9c6789e59d614fb7a6946e4ec7cba60fab8a0e3a96e7d2a949f2358d0af18979f4b188de5a835bf26e08",
            CBC { iv: 0x71960925001be7cafad31f20bc04fdc5 }
        );
        test_encrypt::<AESKey128, CBC>(
            "e7d2e2c7561eb7887f42efc1b374d757",
            "dbf36216b60817b734d8efac6731afef936742989668e9cc5365580d2f892dc8d330b4bcf70dab3bf54c385830c637fa62d2fd63390f75800f1806068bdc9cd882e3ea80dc81f31c945843382172c364273f011bb3381f909f6a33606c1b032f601d54504289228a9326b13e333c0b17447ab3ef45d6a5cb127bb45624513902",
            "5551eaa33fa8621ee9a0bfe20a84f4412d207f68d2d964a6432f9dd44e661b2f0ab6d13afb5978ccdc2febc85b3694465c798dda2b29edf84513b953543350e0d4f0a094e1eb65ffe1263ff2c4db432f13beebf53d879a7231b330b534ed00af41a611daebd51c8773425831a9390e51ecec4229099e46677b83e5195eb4126a",
            CBC { iv: 0xba3579f8a3264991ab714cb97bfa714e }
        );
        test_encrypt::<AESKey128, CBC>(
            "e9f6c0bf8c7cd88c9c6db96f84d09312",
            "369deeb3a3b9d1279bbe06a51bcce1a3b316e7c5e4a73b30fc329ccbbacf840f412b7cff766b4c10577571b1447f231dcd525b555d19c863b2fd72534fd6cb353cca762e5f4dfe6f3dd4974b86a30cf22e4de221c92736232db0f0a49681b7b6e83042e77f63e9872ffe41d5e11bd7bf835c221ad56f4e80c1fc41182792b184",
            "7ba2fb799e797d925ae8975adc819e607b6de2eb7e15173c6d70b83c5f99be7734948251568e6c788ef968f7fbe1f833288d4c9368d9fefc21692b51a57946ba67ca75a0767f91c7cba5955f42556bb9fb42353744e3342347f3fb4d6071d057148af1723d0a73f45e992ae76068f0bea75afa1d306bc587cbde1bc2e2e81ea0",
            CBC { iv: 0x640d609370a1758f788aa5f41b02acb7 }
        );
    }

    #[test]
    fn cbc_decrypt_128() {
        test_decrypt::<AESKey128, CBC>(
            "7c7bd113491baab93472b216aeac8b6d",
            "7a25f32f5b01154354eb0a16e48ed5522f05a05b3453da1f6a760f02a2b21538e41aed339d363e0ac6650ae41c194d06129ddf80abdacecca8ad394247659b2fca2ba0b6527dcc9269f2a0b4d968a954755f97bc34716fa2d5e97cd30485d0d1277008e7942dc4de1c137113761a1f05a1d240f7b0a780d086643b7fc3f9023d",
            "5af646a05817c8db0a6713a29c4cd9c3157c55265ad054244e63f40b5ec29f516f610726852f363239526a391bf379ce80b62a3c7dec7d7f8a2dcdaa7665cfe02d20c5062ceaefae474ca5af9f00a1da429a1bdad76cd8362ef469526afe9b67991e943bb453909ca1e0c32d794c26cebd46654d416d8821b26b4df5a9955d68",
            CBC { iv: 0x505d1a64162102e9859912a71dde6e09 }
        );
        test_decrypt::<AESKey128, CBC>(
            "ae1033bca81a8e8eec6ecf82fd055bb3",
            "e294525f48aa6c8b0570b9bb16079c020f056d4540d8f1894c065b734e081ff0a4654dc845c150145a0bcbbd378a1f6a545c917248ec1c7e5b80f52fe51b716c6e7a2c38ab99b844427ea0681af85052491bcbf39e8282b470c08de77bbb41c6d4a9ccd662c767dbed0905a1c4032b4a30be59db9fa6512784998370eb699401",
            "2d2ddb1fe186167392b0733aa83e5d9ab1835e0a08c4b2c680acdf542b0bc37607c5be8995968db37a049a8c692a5cd9b8aaf8450f11327f0b3811fed66b6846c9c179cc2c1917ec9dbffc026ea57bd8033335ee0e64445a02b46b05f40be8c9b5be59cd15bdf268279e440c1d7553beed14a3bbaa8172d619413c20b5f4f7c2",
            CBC { iv: 0x45e7a23f8e504d9db9b50290fc80df2c }
        );
        test_decrypt::<AESKey128, CBC>(
            "0f4eb6df21e4fd1e73f5be564125a73a",
            "07aecc1744432c9270fe80dd0bef2a17614c8bb7b3982286d2a35cc0fd115f9d72ac5cd214abed7b9711c11c27207c6a4859450f6526a0fe7598b2b0fdfe97eaccfff390f8ee5950d6efb2940426d13ee52ee5a55617b98bd3f171b4a3036155eb4b86293d326d8d968560e0543aa13d513a7ce3154951ef1de07bb2531f600a",
            "50b166f93b3f6ca2c6b800c227f0504175d5e07b09a3871c4e6dcc9e1404d76c0dd3ddca32089286d12876a01116c0fea09031b2d7156abfcf9b786c303e50aeaab8d0442ac0931afd1e282e29526b6533fe67ff2a6bc2ae7e6cb24f60de71775d27314846231460558beb5a283944e142e82a3676f929a99a1e93850b9e748e",
            CBC { iv: 0x074afd533648026395da09bd9251e9da }
        );
    }

    #[test]
    fn cbc_encrypt_192() {
        test_encrypt::<AESKey192, CBC>(
            "0e087966d51f3cac21f20eedb2bbc3916dcf5914fb863f1e",
            "cc46ce077318c83a53b7e7c9be7c9f6bd68daca4ddd35aa85ff4f1176ff74f3dcee85a9c6b7891e116c1d7a59ce40c3518624b326e74cdf9cc29bdd5bb9883c316e559eebe2a06743da7048d5367532b7a6a2d778b0d1e74caa5d50b6901e2b5aa488fc0a3ba714523cde6543a41dfe762bb8cde9d935cb9fd87d99b621956ff",
            "bf9c00d93765dc2ee75a95a9fb9e44891a0c86eb0ab67aa01deeaf2b782a1067e23eb8221de9a53c3c9d99e78c1a7383db819fb9925fb00800065d4470024f334fe40067f6ea296695cd897bc9a240cf28328935399b2c3d21ae8ee3577defbcce86c670b2eda8221b6ce3706bd8161f504f910f65278a01d04becc6714466fb",
            CBC { iv: 0xe349f0e85ba3215f89c376f371819ad5 }
        );
        test_encrypt::<AESKey192, CBC>(
            "03fe9028ae078d6f0006914dea1caf29840860e337657480",
            "f52626e99e708637172d3e8e42f716f3172dd3ea4f43abef7d4f8403745e085912d31f00d04cb315f5fbb09539439504a9df47bd69f0cbf834e7071fe43756d09b9cf874328543d3550a47147eb3053fce55ff9c364665d160b9b49b6a08dc4ff273436d1ea59b1a0f766a5032eed332676ed51e9726bec5aaabc990bc94ce5e",
            "cffb2e76b49533d8a62390c1baa614e9645462c91358fabdc70482d8fe022dd06e3a0b64722b88a99480f1fdb3141192912cfac400d1ce3a4d06eb99af7c0baf95eb9da39f85cdd5d90d189b47f022033723c5d64dcf4f9ed239d8cde546c6c4029b486adb8aae4eeae51c72253d8e21a7663e339981da7fa2780c0d58d72ddc",
            CBC { iv: 0x63352c063b13d0e61d60c3bd0c970375 }
        );
        test_encrypt::<AESKey192, CBC>(
            "bbc0baf4c9eb5ee4af24bcb63a4f1f600f0b4e61c65c3ab6",
            "d5b7a621f4a146a6f83cc7760b0245781d02543095abf836db73508c952880d8048048b5801b8261b77a4d9bfb12eabf4cd022fd39e35a5c7aca6f1d9b07b87202ad217d704280e9be5ac0d9626ea3694b08827cd6a7bbb80595b96b93d0e4970e19002c4d7ffae458a08d38361482e0c35951e014ae98cf12b507e5287c5864",
            "677389164ee082e1a2c17856771c9a6d46812cd56535d727314776c2aafef70befee7be531a9dd53b331fcde69380bfcd1c30a535798320cf5b81409a5dbc2eec5392637b9f9d4fbd83edd124d529a17c0569d8b4020faeea32c62202cea77449e784baca6c4308533b3aa56f66036f9f3043298b569cb30edf035385f017a40",
            CBC { iv: 0x29c8f686af2bc3b9aed351d6050c0318 }
        );
    }

    #[test]
    fn cbc_decrypt_192() {
        test_decrypt::<AESKey192, CBC>(
            "24b45d918615c016eef1d6479a34b784f5d7f02fa0d6b21a",
            "d603dd94886d9132f6d34a0d57affe458311986c6125010493e0cc1e70291f9615870c75dc179e3dcccad31c06098c79290d49a52e4d848c5336156acd3fd8db8c44e2d589a229a0ceaa8b3c616018ffd6584677f9973a6646eaa166b366ee474c181b20d27a5a0b1c744cf958df0874fd96d7088f8a735e08548bda5730ce6c",
            "9b9069c40e0682c1b41e58ca452f98d43d4db5341b1d98d933bbc8fb00632ea7b762498bd6d6f4c0634e29a96dfe98cb77c17a757949e6f9ae6259ba41c4c7f198e33cc763eff98d1f71585109147c8f133c3ffe6d6dcf31d2e49dc0508554bb366ea3ebcc1005910dfd034de8be3182103cb69efa54cca2b515d75e8e9ba841",
            CBC { iv: 0x28854991c1a7fde0880a5358af4af795 }
        );
        test_decrypt::<AESKey192, CBC>(
            "07ed3295210593e9d66d557ed1a8036216e23600d61d9b05",
            "0fc4b38ee02971007b6be2ef31054797d5124150c2e514ac34097046840f49aa144b156ed7da4c52586cc425af7f719440567516d8a09b91442154bbba45e6fb4f086d3d3cde8faf8925c329e260d77dede1835119f5cb690c1c1a4da9f2b27dcd2f431fbdbc72690440bb5fa9055e706ab32258cef23ea93770c999618f9e86",
            "6864a5eee98efa28288189e99ced04a20afe2889e410ca159e790951e74e8b50ad5b4b7904e5c9244fcf1a13ad805b7dd9f45cb0be5bd768ff0d1399991b2992b83cc1a66b43dad246da6746e003cd6ca7c1b9bb225273e66942a901e6844691bdc2543c88798ddedab82a99e8a8ec7f6e64330cd7f10acd2a4c21d9cbe68fbe",
            CBC { iv: 0x85847e689d427b53134280ae897a04e4 }
        );
        test_decrypt::<AESKey192, CBC>(
            "0006f94e54f81c3b188a7119e046d3cd7e41be1fae3fbd36",
            "e4755df27e50bc75bf7ad30d147cad94c5daa0b398684ee05bf43a4901c411ee1216ff248801edf576e4abe0bb630cd59aa8177e14b143e7e225c345234d48d95cc2394454ad62a3c7b7f4873325ae8f32eff9a7d92caa50be6854c80d08a6e4051ae874fa53cdf232f31714b63ce86cb3327b9f4fd99cc759e027c878ee8f76",
            "6f1e91557c015213b56ae4fc704a397d07b118c552b71d0cf5d989ac7eaa122cc10c4c1e848026e444ac95b748ba2023110de7d5bf89f91174317f5cf0a2f43496d6b983f1a8784270d4bbc945f39a6ec4ab3d47ed6f926d71867dc02e0e9404c877c8942addab4c93af15ec2ec28648b5a8aed4a1d92e0587437d329b7e1af9",
            CBC { iv: 0xae9eb12b51577995bfe4ecfab8cf810a }
        );
    }

    #[test]
    fn cbc_encrypt_256() {
        test_encrypt::<AESKey256, CBC>(
            "05d574ed7ee98db38b8375fa6b6a88ce51e2ca59586ee3ecf201b9a51a71d0c8",
            "db750ab3bc60c10f5b4046d00269e8b95cb9c3a82e2ec43e48bc90d6417363bfa2bf2ac04ed8639763c6630c3ee11f2cbe877f34cf0e34f8fdcf15a206d4f7d756548145652b3792efc3ef237eee8e466355c18b9b9376ab15a5dd85a9f850bbbd82935c14ce245c1015ab9042b8ce34f0fb86ec5e88481c60fc97ac549836a4",
            "1948630346dd8c27b2be3bfe3a3d4b3f28bf7da546b2c4ce51a3e8edf4b335036e4e9890cad58c453c683c61e22a619ac3b7cce079fce2d5f27da1566a93f86223ed8759cadb646b14cc2e39c136bff43b4475674d5f013ef71e40d216dbf6df0a589ced394e4b063c5489415d18af38607e97006c2662f4038ee7b5692c6d51",
            CBC { iv: 0x6f0b3150a35e938a13f9aa59b9f82f4c }
        );
        test_encrypt::<AESKey256, CBC>(
            "9f75aec549e7c0d30ce1346151da4b09dba360d9953130bec1948f1d80bb93c0",
            "752f912123d0b0a80fd53f0e6a7118ab46df65f8b00461dbcf3996a7c050827f5aceca25e48a2f240c9feefe7e33931974236d5786f8a8faa744aa1ee4a188b7dff1201d1c9e0d0c8fec61e62a2afdc0b73ba50b2b8004ea193ac82d2e17397abce17063587fbca05ed5f1ea1e8d99316cd94d25038637b97389b2ad3fa36597",
            "00ad41f593d70bc4b631050e7d06f020f6209ad8019ab97f7b916f1d8cbfc8e98a672d434a27540586fbb8dd7e62328c355c3fafe81d78aabad856830cb02221f6b6a2f1d78bceeb7883a14fd575e7b78e4aa7decd0409f4cfc200dce70ddaf6a6deff4050e8e1f786ae87148edecc8db85d281a2b8d05088c5507f4644e11be",
            CBC { iv: 0x862a60556ada445571c102ffb6fa978b }
        );
        test_encrypt::<AESKey256, CBC>(
            "b0809904abeae729a1bf6af4ad9e3962ae7dbe9a6851d53cb5b1c481f7b67850",
            "11ea68fe798dd2a71acf49d9959c6ef797fe8df08cf67540c5cbe14477fb4c1ef241657b57f1e49b314f4d109bd8d31828a5a1340778296295255dced3fc55d0efc43ed86b5ec8badc184a08b24360ed4c439060c76b22ff466073173ffe28664577cb4934338b4b8dafb32ffc257acfda98f073d45a1dae95658c7ba91d9538",
            "55e775b3f3eec58a60dc55c84fa5118b6af86928a8f47b47b9ccee837526d4a87311eac2c5be91e06c9c229c62b5a6fce31bebf8f161dc47aea1cc29653a7c28b12f8ec92ade9a3ea3438cade712edf6afb5477e248d4cbab5e94bd50e83d43217605edf1f72aeaee0ee8aaa33d754709bd452daf565af488b1082bcba43807f",
            CBC { iv: 0x655869d9c47885756538a2478c6fce29 }
        );
    }

    #[test]
    fn cbc_decrypt_256() {
        test_decrypt::<AESKey256, CBC>(
            "df1546aade622978259f528178fddbd95be961b2ce905ac21d56495a32f8e8c0",
            "91158d76371cde061f59cf904733cf6c783a7b0b1edba37af67e7638871cc61916dcaace6531ed4b4d0f112efa16c017e716576efed1d7634051eceb729434f2d8f6cb85a1d61f04fb07e55bea8bfd9f5406c9f0477ec2509ef36fbf8a2aff4e97ee79eb2a3676f3f1f090c88892fb47ba4cd1b67100afe2cc5ded7388610827",
            "7deed2102ea948b716e269e607fc46e2a7f4b506c7fe048feba8dca3eb70d5091f546ac51a427d0c7484c2c86a3f487592486688d26d093414b171957e76ce6702311e5a638b2ca5adcc6346f0313b16ddc89972a7a1b0384eea476250700e7c84a7bf080c87dd57238e270893f83b92589440c68fb84834b1be35908e246142",
            CBC { iv: 0x58c487f30d894bd662aa03b26934dfd8 }
        );
        test_decrypt::<AESKey256, CBC>(
            "b8ecfc97b783f04f46b9ea12f37549c754f8e020d54eb2ace173726ff8b53b5e",
            "b1c509d700f211a5892fc99bdb9b97665d9aeaea810bcc90f7813e386090df1493a9e57304a0d08baa34a2d424b956e7eac666b1e9445ac49e27aceb2e54d640240b2869335463a105e400cbb31eb13ba6d706217bc1b9f537c33fbd30500ba8d6e6aafe3c5970b42726dd2afca980e4306d3b6b870be4192a56977a758c39eb",
            "c5134f13865c690442ca02b4bb2d5475fbb6f54070b80e8ca128b906803f4ce17ac99c42f4fee6aa6541baa43c743d0aac30e155822e16ac5374baa23a5d8515dda6a7033727b018f61d55f98cadf6cb1eac83d59848424c723d2187c40f029be002315f6a26334d78657fc7a482b7c9a6665087b7631484fb1cfcdb0176d9a6",
            CBC { iv: 0xf49d4265d9968c65546ad06876f9d484 }
        );
        test_decrypt::<AESKey256, CBC>(
            "381a668fe0a3688eb1e2b5e9902ea1e4518a6307ba59377823a6e5db3f222a3e",
            "917c2e043f6b3c6e84d3d075b37e31e875c11dc65480be09d0937b0a947787f32945ee314422af542b0fabd14b6f596a2d34fb5cf3a736ac8285680102d7f7e0cc70129e955002b95b813bd32ac32d93fc6abe13ef552816629f2b3b7e99615d29fe96ec17ef555c85355fd92df08f7ae851d3fcb592bf281464c71e92c6aedf",
            "dc45b5e85f36d206a66236436da4226c1a799ad0ef015dd1442c2f6525b6b37807dc3e1f96bc40b648aeaf02c927bae4106acec353beb4fb326b45eca9eb72668ca8fa2bd7ba91bd06f77a2c507b214766636752b9cbe69ef1a34b05c5be8fe5f843059a876761a2940ed60035c770681c156d300f18ba477f5e35f84d0a774c",
            CBC { iv: 0xc0c9ab87e7ba35ce44bea520924d968f }
        );
    }
}
